<!DOCTYPE html>
<html lang="de-formal">

<head>
    <title>UserSettings</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css" />

</head>

<body onload="checkUserStatus()">

    <!-------------------------- Header und Userhandling ---------------------------->
    <iframe id="userRL" src="user.html"></iframe>

    <header class="header-stuck">
        <div id="header-container">
            <div id="menue"><img class="menue" src="img/ff-svg-files/Menue-weiss.svg" alt="menue"></div>
            <div id="user" class="text-specs">
                <span class="userRL" onclick="showUserR()">Register </span>/
                <span class="userRL" onclick="showUserL()">Login</span>
            </div>
        </div>
    </header>

    <h1 id="headline" class="headline-specs">Food Facts</h1>


    <!-------------------------- Inhalt ---------------------------->
    <div id="userSettings" class="text-specs black">
        <p>Meine persönliche Challenge <span id="duration"></span></p><br>
        <div id="userChallengesContainer"></div><br>
        <div id="userPoints"></div><br>
        <!--Emojis einbauen-->
        <div id="act-button">Erstelle dir eine neue Challenge! <a href="challenge.html" onclick="cancelChallenge()"><img
                    class="act-small" src="img/ff-svg-files/act-small.svg"></a></div>
    </div>

    <script>

        //-------------------------- SCRIPT Userhandling ----------------------------

        function showUserR() {
            const myframe = document.getElementById("userRL");
            const register = myframe.contentWindow.document.getElementById("register");
            myframe.style.visibility = "visible";
            register.style.visibility = "visible";
        }

        function showUserL() {
            const myframe = document.getElementById("userRL");
            const login = myframe.contentWindow.document.getElementById("login");
            myframe.style.visibility = "visible";
            login.style.visibility = "visible";
        }

        //-------------------------- SCRIPT userChallenges ----------------------------

        function checkUserStatus() { // brauchen wir das noch?
            const sessionId = window.localStorage.getItem("sessionId");
            if (sessionId != null) {
                userChallengeHandling();
            } // else login
        }

        async function userChallengeHandling() {
            const x = await fetch('/userChallenge', data = {
                method: 'GET',
                headers: {
                    'Authorization': window.localStorage.getItem("sessionId")
                }
            });
            const userChallenges = await x.json();
            for (oneUserChallenge of userChallenges) {
                if (oneUserChallenge.Status != 2 && oneUserChallenge != null) {
                    getUserChallenge(oneUserChallenge);
                }
                getPointsUserChallenge();
            }
        }

        function getUserChallenge(oneUserChallenge) {
            const duration = oneUserChallenge.Duration;
            document.getElementById("duration").innerHTML = "(läuft noch bis " + duration + ")";

            const id = oneUserChallenge.ID;
            const text = oneUserChallenge.Description;

            let divE = document.createElement("div");
            let labelE = document.createElement("LABEL");
            labelE.id = "challengeID_" + id;

            let userChallenges = document.createElement("INPUT");
            userChallenges.type = "checkbox";
            userChallenges.name = "userChallenge";
            userChallenges.value = id;

            userChallenges.checked = (oneUserChallenge.Status === 1);
            userChallenges.onchange = toggleUserChallenge;

            labelE.appendChild(userChallenges);
            labelE.appendChild(document.createTextNode(text));
            divE.appendChild(labelE)
            document.getElementById("userChallengesContainer").appendChild(divE);
        }

        async function toggleUserChallenge(event) {
            console.log(event)
            const checkbox = event.target;
            const parId = parseInt(checkbox.value);
            const parStatus = checkbox.checked ? 1 : 0;

            await fetch('/userChallenge/toggle', data = {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': window.localStorage.getItem("sessionId")
                },
                body: JSON.stringify({
                    id: parId,
                    status: parStatus,
                })
            });
            getPointsUserChallenge();
        }

        async function getPointsUserChallenge() {
            const x = await fetch('/userChallengePoints', data = {
                method: 'GET',
                headers: {
                    'Authorization': window.localStorage.getItem("sessionId")
                }
            });
            const userPoints = await x.json();
            document.getElementById("userPoints").innerHTML = userPoints.Points;
        }

        async function cancelChallenge() {
            const parStatus = 2;

            await fetch('/userChallenge/cancel', data = {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': window.localStorage.getItem("sessionId")
                },
                body: JSON.stringify({
                    status: parStatus,
                })
            });
        }

    </script>

</body>

</html>