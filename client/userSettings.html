<!DOCTYPE html>
<html lang="de-formal">

<head>
    <title>UserSettings</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css" />

</head>

<body onload="getUserChallenges(), getPointsUserChallenge()">

    <div id=userSettings>
        <p>Meine persönliche Challenge <span id="duration"></span></p><br>
        <div id="userChallengesContainer"></div><br>

        <div id="userPoints"></div><br>
        <!--Emojis einbauen-->

        <input type="button" value="Challenge abbrechen" onclick="cancelChallenge()">
    </div>

    <script>

        async function getUserChallenges() {
            const x = await fetch('/userSettings');
            const userChallenges = await x.json();
            // document.getElementById("userChallengesContainer").innerHTML = ""
            for (oneUserChallenge of userChallenges) {

                const duration = oneUserChallenge.Duration;
                document.getElementById("duration").innerHTML = "(läuft noch bis " + duration + ")";

                const id = oneUserChallenge.ID;
                const text = oneUserChallenge.Description;

                let divE = document.createElement("div");
                let labelE = document.createElement("LABEL");
                labelE.id = "challengeID_" + id;

                let userChallenges = document.createElement("INPUT");
                userChallenges.type = "checkbox";
                userChallenges.name = "userChallenge";
                userChallenges.value = id;

                userChallenges.checked = (oneUserChallenge.Status === 1);
                userChallenges.onchange = toggleUserChallenge;

                labelE.appendChild(userChallenges);
                labelE.appendChild(document.createTextNode(text));
                divE.appendChild(labelE)
                document.getElementById("userChallengesContainer").appendChild(divE);
            }
        }

        async function toggleUserChallenge(event) {
            console.log(event)
            const checkbox = event.target;
            const parId = parseInt(checkbox.value);
            const parStatus = checkbox.checked ? 1 : 0;

            await fetch('/userSettings', data = {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: parId,
                    status: parStatus,
                })
            });
        }

        async function getPointsUserChallenge() {
            const x = await fetch('/userSettings/points');
            const userPoints = await x.json();
            document.getElementById("userPoints").innerHTML = userPoints.Points;
        }

        async function cancelChallenge() {
            const parStatus = 2;
            const parUserId = 1;

            await fetch('/userSettings/cancel', data = {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: parStatus,
                    userId: parUserId,
                })
            });
        }

    </script>


</body>

</html>