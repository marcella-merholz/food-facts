<!DOCTYPE html>
<html lang="de-formal">

<head>
    <title>Challenge</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css" />
</head>

<body onload="getChallenges()">

    <!-------------------------- Header und Userhandling ---------------------------->

    <iframe id="userRL" src="user.html"></iframe>

    <header class="header-stuck">
        <div id="header-container">
            <div id="menue"><img class="menue" src="img/ff-svg-files/Menue-weiss.svg" alt="menue"></div>
            <div id="user" class="text-specs">
                <span class="userRL" onclick="showUserR()">Register </span>/
                <span class="userRL" onclick="showUserL()">Login</span>
            </div>
        </div>
    </header>

    <h1 id="headline" class="headline-specs">Food F<span id="act-container"><img class="act"
                src="img/ff-svg-files/act-small.svg"></span>acts
        <!--<span id="world">üåçÔ∏é</span>-->
    </h1>

    <div id=select class="text-specs black">

        <label>Zeitraum festlegen: <input id="duration" type="date" name="duration"></label><br>
        <div id="challengeContainer" class="text-specs black"></div><br>
        <input class="text-specs black send" type="button" value="Send" onclick="selectByUser()">
        <div id="selectedConfirmation"></div>
    </div>


    <script>

        //-------------------------- SCRIPT Userhandling ----------------------------

        function showUserR() {
            const myframe = document.getElementById("userRL");
            const register = myframe.contentWindow.document.getElementById("register");
            myframe.style.visibility = "visible";
            register.style.visibility = "visible";
        }

        function showUserL() {
            const myframe = document.getElementById("userRL");
            const login = myframe.contentWindow.document.getElementById("login");
            myframe.style.visibility = "visible";
            login.style.visibility = "visible";
        }

        //-------------------------- SCRIPT Challenges ----------------------------

        async function getChallenges() {
            const x = await fetch('/challenges');
            const challenges = await x.json();
            for (oneChallenge of challenges) {
                const id = oneChallenge.ID;
                const text = oneChallenge.Description;

                let divE = document.createElement("div");
                let labelE = document.createElement("LABEL");
                labelE.id = "id_" + id;

                let challenge = document.createElement("INPUT");
                challenge.type = "checkbox";
                challenge.name = "challenge";
                challenge.value = id;

                labelE.appendChild(challenge);
                labelE.appendChild(document.createTextNode(text));
                divE.appendChild(labelE);
                document.getElementById("challengeContainer").appendChild(divE);
            }
        }

        async function selectByUser() {
            const sessionId = window.localStorage.getItem("sessionId");
            if (sessionId != null) {
                const x = await fetch('/sessionUser/' + sessionId);
                const userId = await x.json();
                sendSelected(userId);
            }
        }

        async function sendSelected(userId) {
            let challengeCont = document.getElementById("challengeContainer");
            let challengeList = [];
            challengeCont.childNodes.forEach(divElement => {
                let labelE = divElement.childNodes[0]
                let inputE = labelE.childNodes[0]
                challengeList = [...challengeList, { id: inputE.value, status: inputE.checked }]
            });
            const parDuration = document.getElementById('duration').value;
            const parUserId = userId;

            const x = await fetch('/challengeSelect', data = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    challenges: challengeList,
                    duration: parDuration,
                    userId: parUserId,
                })
            });
            const result = await x.json()
            document.getElementById("selectedConfirmation").innerHTML = result.message;
        }

    </script>

</body>

</html>